---
title: "SamplingDesignTools: Tools for Dealing with Complex Sampling Designs"
date: "Created on 2020-05-29. Updated on `r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
set.seed(1234)
library(knitr)
opts_chunk$set(echo = TRUE, collapse = TRUE, cache = TRUE)
print_percent <- function(prop, n_digits = 1) {
  str <- paste0("%.", n_digits, "f%%")
  sprintf(str, prop * 100)
}
```

# 0 Getting Started

## Installation

Install the SamplingDesignTools package from GitHub (package devtools needed):

```{r, eval=FALSE}
devtools::install_github("nyilin/SamplingDesignTools")
```

Load packages used:

```{r}
library(SamplingDesignTools)
library(survival)
library(dplyr)
library(Epi) # To draw (non-counter-matched) nested case-control sample
```

## Example Datasets

This package uses two simulated cohort data (`cohort_1` and `cohort_2`)for
illustrative purpose.

### `cohort_1`

Dataset `cohort_1` consists of 10,000 subjects with age simulated from 
$N(55, 10^2)$) and gender simulated with $P(\text{Male}=0.5)$. The survival
outcome simulated from the following true hazard:
$$\log \{h(t)\} = \log \{h_0\} + \log(1.1) \text{Age} + \log(2) \text{Gender}.$$

Time ($t$) is measured in years and censored at 25 years. Censoring is indicated 
by $y=0$.

```{r}
data("cohort_1")
dim(cohort_1)
table(cohort_1$y)
kable(head(cohort_1))
m_cox_cohort_1 <- coxph(Surv(t, y) ~ age + gender, data = cohort_1)
summary(m_cox_cohort_1)
```

### `cohort_2`

Dataset `cohort_2` consists of 100,000 subjects, with survival outcome simulated 
from the following true hazard:
$$\log \{h(t)\} = \log \{h_0\} + \log(1.5)x + \log(4)z + \log(2)xz + 
\log(1.01) \text{Gender} + \log(1.01) \text{Age}.$$

Time ($t$) is measured in years and censored at 25 years. Censoring is indicated 
by $y=0$. Age is also recorded in 6 categories: <35, 36-45, 46-55, 56-65, 66-75
and >75.

```{r}
data("cohort_2")
dim(cohort_2)
table(cohort_2$y)
kable(head(cohort_2))
m_cox_cohort_2 <- coxph(Surv(t, y) ~ x * z + age + gender, data = cohort_2)
summary(m_cox_cohort_2)
```

# 1 Drawing counter-matched sample

This section describes how to use `draw_ncc_cm()` to draw counter-matched nested 
case-control (NCC) samples, and subsequently how to analyze the sample using a
weighted conditional likelihood approach.

Examples in this section use `cohort_1` as the underlying cohort, and considers 
the continuous variable age as the continuous exposure of interest, just for 
illustrative purpose.

Reference:

- Langholz B. [Counter‐Matching](https://onlinelibrary.wiley.com/doi/abs/10.1002/9781118445112.stat05225). Wiley StatsRef: Statistics Reference Online. 2014 Apr 14.

## Counter-match on binary surrogate

This analysis uses dichotomous age (at 50 years) as a surrogate to the actual
exposure to draw a counter-matched NCC sample with 1 control per case.

```{r}
cohort_1$age_bin <- as.numeric(cohort_1$age < 50)
table(cohort_1$age_bin)
ncc_cm_bin <- draw_ncc_cm(cohort = cohort_1, y_name = "y", t_name = "t", 
                          match_var_name = "age_bin", 
                          include_var_name = c("age", "gender"), ml = 1)
head(ncc_cm_bin)
table(ncc_cm_bin$age_bin, ncc_cm_bin$y)
m_clogit_bin <- clogit(y ~ age + gender + strata(set) + offset(log(weight)), 
                       data = ncc_cm_bin)
```

## Counter-match on categorical surrogate

This analysis divided age into 4 categories (at 40, 50 and 60 years) to create a
categorical surrogate to the exposure, and subsequently drew a counter-matched 
NCC sample with one control per age category, i.e., in total 3 controls per case.

```{r}
cohort_1$age_quart <- cut(cohort_1$age, breaks = c(-Inf, 40, 50, 60, Inf), 
                          labels = 1:4, include.lowest = TRUE)
table(cohort_1$age_quart)
ncc_cm_quart <- draw_ncc_cm(cohort = cohort_1, y_name = "y", t_name = "t", 
                            match_var_name = "age_quart", 
                            include_var_name = c("age", "gender"), ml = 1)
head(ncc_cm_quart, 20)
table(ncc_cm_quart$age_quart)
m_clogit_quart <- clogit(y ~ age + gender + strata(set) + offset(log(weight)), 
                         data = ncc_cm_quart)
```

## Compare results

```{r}
results_1 <- rbind(summary(m_cox_cohort_1)$coef, 
                   summary(m_clogit_bin)$coef, 
                   summary(m_clogit_quart)$coef)
rownames(results_1) <- NULL
kable(data.frame(
  Data = c("Full cohort", "", 
           "NCC-CM, 1 control per case", "", 
           "NCC-CM, 3 controls per case", ""), 
  Variable = rep(c("Age", "Male"), 3), 
  `True HR` = rep(c(1.1, 2), 3),
  `Estimated HR` = results_1[, "exp(coef)"], 
  `SE of log(HR)` = results_1[, "se(coef)"], 
  `p-value` = results_1[, "Pr(>|z|)"], check.names = FALSE
), digits = c(0, 0, 1, 2, 3, 3))
```

# 2 Compute KM-type weights for NCC sample

This section describes how to use `compute_km_weights()` to draw NCC samples and 
compute Kaplan-Meier type (KM-type) weights, and subsequently how to analyze the
sample using a weighted Cox approach.

Examples in this section use `cohort_2` as the underlying cohort.

References:

- Samuelsen SO. [A psudolikelihood approach to analysis of nested case-control studies](https://academic.oup.com/biomet/article-abstract/84/2/379/233968?redirectedFrom=fulltext). Biometrika. 1997 Jun 1;84(2):379-94.
- Borgan Ø, Samuelsen SO. [A review of cohort sampling designs for Cox's regression model: potentials in epidemiology](https://www.ntnu.no/ojs/index.php/norepid/article/view/292). Norsk Epidemiologi. 2003;13(2).

## 1:2 NCC matched on age and gender

Consider an idealistic scenario, where the full cohort is available to calculate
the KM-type weights. A NCC sample was draw (using `Epi::ccwc()`) with 2 controls
per case, matched on age group and gender.

```{r}
n_per_case <- 2
ncc_2 <- ccwc(exit = t, fail = y, controls = n_per_case, 
              match = list(age_cat, gender), include = list(x, age, z), 
              data = cohort_2, silent = TRUE)
names(ncc_2)[-(1:4)] <- c("age_cat", "gender", "x", "age", "z")
head(ncc_2, 12)
# Create the sampling and status indicator
sample_stat <- numeric(nrow(cohort_2))
sample_stat[unique(ncc_2$Map[ncc_2$Fail == 0])] <- 1
sample_stat[ncc_2$Map[ncc_2$Fail == 1]] <- 2
table(sample_stat)
ncc_2_nodup <- compute_km_weights(cohort = cohort_2, t_name = "t", y_name = "y",
                                  sample_stat = sample_stat, 
                                  match_var_names = c("age_cat", "gender"), 
                                  n_per_case = n_per_case)
head(ncc_2_nodup)
summary(ncc_2_nodup$km_weight)
m_cox_ncc_2 <- coxph(Surv(t, y) ~ x * z + gender + age, data = ncc_2_nodup,
                     weights = km_weight, robust = TRUE)
m_clogit_ncc_2 <- clogit(Fail ~ x * z + strata(Set), data = ncc_2)
```

By breaking the matching in the NCC and performing a weighted analysis, users
are also able to estimate the absolute risk that is not available from NCC in
conventional conditional approach. This is not illustrated here but have been
described in following papers:

- Salim A, Delcoigne B, Villaflores K, Koh WP, Yuan JM, van Dam RM, Reilly M. [Comparisons of risk prediction methods using nested case‐control data](https://pubmed.ncbi.nlm.nih.gov/27734520/). Statistics in medicine. 2017 Feb 10;36(3):455-65.
- Delcoigne B, Colzani E, Prochazka M, Gagliardi G, Hall P, Abrahamowicz M, Czene K, Reilly M. [Breaking the matching in nested case–control data offered several advantages for risk estimation](https://pubmed.ncbi.nlm.nih.gov/27923734/). Journal of clinical epidemiology. 2017 Feb 1;82:79-86.


## Compare results

Compared to conventional conditional logistic regression analysis of matched
sets, weighted Cox analysis of sampled subjects produces smaller SE, and
provides estimates for matching factors.

```{r}
results_2 <- rbind(summary(m_cox_cohort_2)$coef, 
                   summary(m_clogit_ncc_2)$coef, 
                   summary(m_cox_ncc_2)$coef[, -3])
results_2 <- data.frame(Variable = rownames(results_2), results_2, 
                        check.names = FALSE)
rownames(results_2) <- NULL
kable(data.frame(
  Data = c("Full cohort", rep("", 4), 
           "NCC (clogit)", rep("", 2), 
           "NCC (weighted Cox)", rep("", 4)), 
  Variable = results_2$Variable, 
  `True HR` = c(c(1.5, 4, 1.01, 1.01, 2), 
                c(1.5, 4, 2), c(1.5, 4, 1.01, 1.01, 2)),
  `Estimated HR` = results_2[, "exp(coef)"], 
  `SE of log(HR)` = results_2[, "se(coef)"], 
  `p-value` = results_2[, "Pr(>|z|)"], check.names = FALSE
), digits = c(0, 0, 2, 2, 3, 3))
```

# 3 Compute weights for NCC without full cohort

KM-type weights can be computed for the NCC sample as long the time of
event/censoring for each subject is available, and the number of subjects at
risk can be obtained (or approximated) elsewhere. 

This section considers a more realistic scenario where the cohort is no longer
available, and subjects at risk are approximated using the number of subjects at
risk in a year.

To match NCC sample to the coarsened time frame, create a variable `t_yr` by 
rounding the exact event/censoring time, `t` to the next integer, and use this
coarsened time to compute the number at risk:

```{r}
ncc_2$t <- cohort_2$t[ncc_2$Map]
ncc_2$t_yr <- ceiling(ncc_2$t)
cohort_2$t_yr <- ceiling(cohort_2$t)
risk_table_coarse <- compute_risk_table(cohort = cohort_2, t_name = "t_yr", 
                                        y_name = "y", 
                                        match_var_names = c("age_cat", "gender"))
head(risk_table_coarse)
```

In reality, number at risk at each event time may be approximated by, e.g., size
of the relevant sub-population at mid-year. In such case, user may use the 
following function to generate a template for `risk_table_coarse` to fill in:

```{r}
risk_table_template <- prepare_risk_table(ncc = ncc_2, t_match_name = "t_yr", 
                                          y_name = "Fail", 
                                          match_var_names = c("gender", "age_cat"), 
                                          csv_file = NULL)
head(risk_table_template)
```

This template will be written to a `csv` if specified by `csv_file`, making it 
easier to supply information regarding the cohort that is required for computing 
the KM-type weights.

Assuming that `risk_table_coarse` is the approximated risk table obtained from
external sources, the KM-type weights for `ncc_2` generated in the previous
section can be computed using the same `compute_km_weights()` function and 
subsequently analyzed using a weighted Cox approach:

```{r}
ncc_nodup2 <- compute_km_weights(ncc = ncc_2[, -1], 
                                 risk_table_manual = risk_table_coarse, 
                                 t_name = "t", y_name = "Fail", 
                                 t_match_name = "t_yr",
                                 id_name = "Map", 
                                 match_var_names = c("age_cat", "gender"), 
                                 n_per_case = 5)
m_cox_ncc_2_v2 <- coxph(Surv(t, Fail) ~ x * z + age + gender, 
                        data = ncc_nodup2, weights = km_weight, robust = TRUE)
```

Compare with results when the full cohort is available:

```{r}
results_3 <- rbind(summary(m_cox_cohort_2)$coef, 
                   summary(m_cox_ncc_2)$coef[, -3], 
                   summary(m_cox_ncc_2_v2)$coef[, -3])
results_3 <- data.frame(Variable = rownames(results_3), results_3, 
                        check.names = FALSE)
rownames(results_3) <- NULL
kable(data.frame(
  Data = c("Full cohort", rep("", 4), 
           "NCC (weighted Cox)", rep("", 4),
           "NCC (weighted Cox, approximated weights)", rep("", 4)), 
  Variable = results_3$Variable, 
  `True HR` = rep(c(1.5, 4, 1.01, 1.01, 2), 3),
  `Estimated HR` = results_3[, "exp(coef)"], 
  `SE of log(HR)` = results_3[, "se(coef)"], 
  `p-value` = results_3[, "Pr(>|z|)"], check.names = FALSE
), digits = c(0, 0, 2, 2, 3, 3))
```

# 4 Weighted analysis of (more) extreme case-control samples

An extreme case-control (ECC) study is only interested in "early deaths" design,
and a more extreme case-control (MECC) further restricts candidate controls to
"longer survivors". These two types of study designs are described in the figure
below.

![Extreme case-control (ECC) and more extreme case-control (MECC). Dots denote events.](www/MECC.png){width=50%}

This section illustrates the weighted analysis of MECC samples using the
conditional approach described in Section 2.2 of Salim et al (2014), using the
simulated cohort described in Section 1 of this paper:

- Salim A, Ma X, Fall K, Andrén O, Reilly M. [Analysis of incidence and prognosis from 'extreme' case‐control designs](https://pubmed.ncbi.nlm.nih.gov/24980445/). Statistics in medicine. 2014 Dec 30;33(30):5388-98.

The example in this section uses `cohort_1` as the underlying cohort. For
illustrative purpose, a MECC sample was drawn by frequency-matching 2 controls
to each case on gender. "Early deaths" were defined as events before 
$\tau_0 = 5$ years of follow-up, and "long survivors" were defined as subjects
who did not have the event in the first $\tau = 15$ years of follow-up. Note
that an event in a MECC study (`y_mecc`) has a different definition as an event
in the original cohort study.

```{r}
set.seed(1)
dat_mecc <- draw_mecc(cohort = cohort_1, tau0 = 5, tau = 15,
                      id_name = "id", t_name = "t", delta_name = "y",
                      match_var_names = "gender", n_per_case = 2)
kable(head(dat_mecc))
table(y = dat_mecc$y, y_mecc = dat_mecc$y_mecc)
```

As the conditional analysis of the MECC sample assumes individual matching, the
function `draw_mecc` randomly matches controls to each case to form matched
sets, indicated by the variable `set_id_mecc`. In addition, this function 
provides the estimated baseline survival probabilities (i.e., $\hat{S}(t_i)$ and 
$\hat{S}(\tau)$) that are needed to compute the weighted likelihood.

The weighted approach estimates the HR, where all covariates need to be centred
at the cohort average:

```{r}
dat_mecc$age_c <- dat_mecc$age - mean(cohort_1$age)
# When there is only a single coefficient in, users should provide reasonable 
# lower and upper limits for the estimate:
m_mecc <- analyse_mecc_cond(
  y_name = "y_mecc", x_formula = ~ age_c, set_id_name = "set_id_mecc",
  surv = dat_mecc$surv, surv_tau = dat_mecc$surv_tau, mecc = dat_mecc,
  lower = -1, upper = 1 
)
round(m_mecc$coef_mat[, -1], 3)
coef_cox_cohort_1 <- summary(m_cox_cohort_1)$coef
kable(data.frame(
  Data = c("Full cohort", "1:2 MECC, weighted"), 
  Variable = "Age", 
  `True HR` = 1.1,
  `Estimated HR` = c(coef_cox_cohort_1["age", "exp(coef)"], 
                     m_mecc$coef_mat["age_c", "exp_est"]), 
  `SE of log(HR)` = c(coef_cox_cohort_1["age", "se(coef)"], 
                     m_mecc$coef_mat["age_c", "se"]), 
  `p-value` = c(coef_cox_cohort_1["age", "Pr(>|z|)"], 
                     m_mecc$coef_mat["age_c", "pval"]), 
  check.names = FALSE
), digits = c(0, 0, 1, 2, 3, 3))
```
